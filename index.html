<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bitácora Óptica AAXIS</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background-color: #003366; color: white; padding: 20px; text-align: center; font-size: 24px; }
    .container { padding: 20px; }
    .actions { display: flex; gap: 20px; margin-bottom: 20px; }
    .action-box {
      flex: 1; background-color: #007acc; color: white; text-align: center;
      padding: 30px; border-radius: 8px; cursor: pointer; font-size: 18px;
    }
    .action-box:hover { background-color: #005fa3; }
    .form-section, .search-section {
      display: none; background-color: white; padding: 20px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    form label { display: block; margin: 10px 0 5px; }
    form input, form textarea {
      width: 100%; padding: 8px; margin-bottom: 10px;
    }
    button {
      padding: 10px 20px; margin-right: 10px;
      background-color: #007acc; color: white;
      border: none; border-radius: 5px; cursor: pointer;
    }
    .client-result {
      border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;
      border-radius: 5px; background-color: #fafafa;
    }
    .visit-entry {
      background-color: #eef; padding: 10px; margin-top: 10px;
      border-left: 3px solid #007acc;
    }
    .client-result {
  border: 2px solid #ccc;
  border-radius: 10px;
  padding: 1em;
  margin-bottom: 1em;
  background-color: #f9f9f9;
}

.client-result input {
  display: block;
  width: 100%;
  margin-bottom: 8px;
  padding: 6px;
  border-radius: 5px;
  border: 1px solid #aaa;
}

.client-result button {
  margin-right: 10px;
  margin-top: 10px;
  padding: 5px 12px;
  border: none;
  border-radius: 6px;
  background-color: #007BFF;
  color: white;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.client-result button:hover {
  background-color: #0056b3;
}
#formulario-visita {
  background-color: white;
  padding: 20px;
  margin: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
#formulario-visita input,
#formulario-visita textarea {
  display: block;
  width: 100%;
  margin-bottom: 10px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #aaa;
}
#formulario-visita button {
  padding: 10px 20px;
  background-color: #007acc;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
#formulario-visita button:hover {
  background-color: #007acc;
}

  </style>
</head>
<body>
  <header>Bitácora Óptica AAXIS</header>
  <div class="container">
   <div class="actions">
  <div class="action-box" onclick="mostrarFormulario()">
    <div style="display: flex; flex-direction: column; align-items: center;">
      <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
        <path d="M15 14c2.7 0 5 2.3 5 5v1H4v-1c0-2.7 2.3-5 5-5h6zm-3-2c-1.7 0-3-1.3-3-3s1.3-3 
                 3-3 3 1.3 3 3-1.3 3-3 3zM19 3h2v4h4v2h-4v4h-2V9h-4V7h4V3z"/>
      </svg>
      <span style="margin-top: 10px;">Agregar nuevo cliente</span>
    </div>
  </div>

  <div class="action-box" onclick="mostrarBusqueda()">
    <div style="display: flex; flex-direction: column; align-items: center;">
      <svg width="40" height="40" fill="white" viewBox="0 0 24 24">
        <path d="M10 2a8 8 0 015.3 13.9l5.4 5.4-1.4 1.4-5.4-5.4A8 8 0 1110 2zm0 
                 2a6 6 0 100 12 6 6 0 000-12z"/>
      </svg>
      <span style="margin-top: 10px;">Buscar cliente</span>
    </div>
  </div>
</div>


    <div class="form-section" id="formularioCliente">
      <h3>Agregar Cliente</h3>
      <form id="clienteForm">
        <label>Nombre del cliente:</label>
        <input type="text" name="nombre" required>
        <label>Dirección:</label>
<label>Calle:</label>
<input type="text" name="calle" />
<label>Colonia:</label>
<input type="text" name="colonia" />
<label>Código Postal:</label>
<input type="text" name="cp" />

        <label>Armazón:</label>
        <input type="text" name="armazon">
        <label>Graduación:</label>
         <label>O.D:</label>
        <input type="text" name="ojode">
         <label>O.I:</label>
        <input type="text" name="ojoiz">
         <label>ADD.:</label>
        <input type="text" name="add">
        <label>Material:</label>
        <input type="text" name="material">
        <label>Orden de Compra (fecha):</label>
        <input type="date" name="orden">
        
        <label>Fecha de Entrega (fecha):</label>
        <input type="date" name="entrega">
        <label>Teléfono:</label>
        <input type="number" name="telefono">
        <label for="fechaNacimiento">Fecha de Nacimiento:</label>
        <input type="date" id="fechaNacimiento" name="fechaNacimiento" />

        <label>Observaciones:</label>
        <textarea name="obse"></textarea>
        <button type="submit">Agregar nuevo cliente</button>
      </form>
    </div>

    <div class="search-section" id="busquedaCliente">
      <h3>Buscar Cliente</h3>
      <input type="text" placeholder="Buscar por nombre o teléfono" oninput="buscarCliente(this.value)">
      <div id="resultadosBusqueda"></div>
    </div>
  </div>
<div id="formulario-visita" style="display: none;">
  <h3>Agregar Visita</h3>
  <input type="date" id="orden" placeholder="Fecha de orden"><br>
  <input type="date" id="entrega" placeholder="Fecha de entrega"><br>
  <input type="text" id="armazon" placeholder="Armazón"><br>
   <label>Graduación:</label>
  <input type="text" id="ojode" placeholder="O.D"><br>
  <input type="text" id="ojoiz" placeholder="O.I"><br>
  <input type="text" id="add" placeholder="ADD."><br>
  <input type="text" id="material" placeholder="Material"><br>
  <textarea id="observaciones" placeholder="Observaciones"></textarea><br>
  <button onclick="guardarNuevaVisita()">Guardar Visita</button>
  <button  onclick="cancelarFormularioVisita()">Cancelar</button>
</div>


  <script>
    let lastKey = null;
let firstLoad = true;
let pageSize = 15;

    let clienteSeleccionadoId = null;

    // ⚙️ CONFIGURA TU FIREBASE AQUÍ
    const firebaseConfig = {
  apiKey: "AIzaSyAr08Q_WusgIoBw1-dX7n8t6QuG4kv0JtI",
  authDomain: "bitacarooptica.firebaseapp.com",
  databaseURL: "https://bitacarooptica-default-rtdb.firebaseio.com",
  projectId: "bitacarooptica",
  storageBucket: "bitacarooptica.firebasestorage.app",
  messagingSenderId: "694465246261",
  appId: "1:694465246261:web:7ee0524dcbb21c6eceed7c",
  
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function mostrarFormulario() {
      clienteSeleccionadoId = null; // ✅ Limpia estado anterior
  document.getElementById('clienteForm').reset(); // ✅ Limpia los campos del formulario
  document.getElementById('formularioCliente').style.display = 'block';
  document.getElementById('busquedaCliente').style.display = 'none';
    }

   function mostrarBusqueda() {
  document.getElementById('busquedaCliente').style.display = 'block';
  document.getElementById('formularioCliente').style.display = 'none';
  document.getElementById('formulario-visita').style.display = 'none';
  document.getElementById('resultadosBusqueda').innerHTML = "";

  lastKey = null;
  firstLoad = true;
  cargarClientes(); // ✅ llamada correcta
}


   

    function buscarCliente(valor) {
  const resultados = document.getElementById("resultadosBusqueda");
  resultados.innerHTML = "";

  if (valor.trim() === "") {
    // Si el input está vacío, volver a cargar todos los clientes
    db.ref("clientes").once("value", snapshot => {
      const data = snapshot.val();

      if (!data) {
        resultados.innerHTML = "<p>No hay clientes registrados.</p>";
        return;
      }

      Object.entries(data).forEach(([id, cliente]) => {
        const div = document.createElement("div");
        div.className = "client-result";
        div.innerHTML = `
          <strong>${cliente.nombre}</strong><br>
          Tel: ${cliente.telefono || "-"}<br>
          <button onclick="verDetalleCliente('${id}')">Ver detalles</button>
        `;
        resultados.appendChild(div);
      });
    });
    return;
  }

  // Búsqueda normal si hay texto
  db.ref("clientes").once("value", snapshot => {
    const data = snapshot.val();
    if (!data) return;

    Object.entries(data).forEach(([id, cliente]) => {
      const nombre = cliente.nombre.toLowerCase();
      const telefono = cliente.telefono || "";
      if (nombre.includes(valor.toLowerCase()) || telefono.includes(valor)) {
        const div = document.createElement("div");
        div.className = "client-result";
        div.innerHTML = `
          <strong>${cliente.nombre}</strong><br>
          Tel: ${cliente.telefono || "-"}<br>
          <button onclick="verDetalleCliente('${id}')">Ver detalles</button>
        `;
        resultados.appendChild(div);
      }
    });

    if (resultados.innerHTML === "") {
      resultados.innerHTML = "<p>No se encontraron coincidencias.</p>";
    }
  });
}



    function eliminarCliente(id) {
      if (confirm("¿Estás seguro de eliminar este cliente y todas sus visitas?")) {
        db.ref("clientes/" + id).remove()
          .then(() => alert("Eliminado correctamente."))
          .catch(err => alert("Error al eliminar: " + err));
      }
    }
   function verDetalleCliente(id) {
  const resultados = document.getElementById("resultadosBusqueda");
  resultados.innerHTML = "";
  clienteSeleccionadoId = id;

  db.ref("clientes/" + id).once("value", snapshot => {
    const cliente = snapshot.val();
    if (!cliente) return;

    const div = document.createElement("div");
    div.className = "client-result";

    div.innerHTML += `
      <div style="margin-top: 20px;">
        <button onclick="mostrarBusqueda()">Regresar a búsqueda</button>
      </div>

      <h4>Cliente: ${cliente.nombre}</h4>
      <p><strong>Teléfono:</strong> ${cliente.telefono || "-"}</p>
      <p><strong>Fecha de Nacimiento:</strong> ${cliente.fechaNacimiento ? new Date(cliente.fechaNacimiento).toLocaleDateString() : "-"}</p>
      <p><strong>Dirección:</strong><br>
  Calle: ${cliente.calle || "-"}<br>
  Colonia: ${cliente.colonia || "-"}<br>
  C.P: ${cliente.cp || "-"}
</p>


<button onclick="mostrarFormularioEdicion('${id}')">Actualizar</button>


      <button onclick="mostrarFormularioVisita('${id}')">Agregar visita</button>
      <button onclick="eliminarCliente('${id}')">Eliminar</button>

     <h5>Historial de visitas:</h5>
${
  cliente.visitas
    ? cliente.visitas.map((v, i) => `
        <div class="visit-entry" id="visita-${i}">
          <strong>Visita ${i + 1}</strong><br>
          Fecha de Orden: ${v.orden || "-"}<br>
          Fecha de Entrega: ${v.entrega || "-"}<br>
          Material: ${v.material || "-"}<br>
          <label>Graduación:</label><br>
          O.D: ${v.ojode || "-"}<br>
          O.I: ${v.ojoiz || "-"}<br>
          ADD.: ${v.add || "-"}<br>
          Armazón: ${v.armazon || "-"}<br>
          Observaciones: ${v.obse || "-"}<br>
          <button onclick="mostrarFormularioActualizarVisita('${id}', ${i})">Actualizar visita</button>
          <button onclick="eliminarVisita('${id}', ${i})">Eliminar visita</button>
          <div id="formularioActualizarVisita-${i}"></div>
        </div>
      `).join("")
    : "<p>No hay visitas registradas.</p>"
}

    `;
    resultados.appendChild(div);
  });
}



function actualizarCliente(id) {
  const clienteActualizado = {
  nombre: document.getElementById("nombre_" + id).value,
  telefono: document.getElementById("telefono_" + id).value,
    fechaNacimiento: document.getElementById("fechaNacimiento_" + id).value,
  calle: document.getElementById("calle_" + id).value,
  colonia: document.getElementById("colonia_" + id).value,
  cp: document.getElementById("cp_" + id).value
};


  db.ref("clientes/" + id).update(clienteActualizado)
    .then(() => {
      alert("Cliente actualizado correctamente.");
      buscarCliente(clienteActualizado.nombre); // Vuelve a cargar resultados
    })
    .catch(err => alert("Error al actualizar: " + err));
}

function agregarVisita(id) {
    const orden = prompt("Fecha de orden (YYYY-MM-DD):");
    const entrega = prompt("Fecha de entrega (YYYY-MM-DD):");
    const armazon = prompt("Armazón:");
    const ojode = prompt("O.D:");
  const ojoiz = prompt("O.I:");
  const add = prompt("ADD.:");
    const material = prompt("Material:");
    const observaciones = prompt("Observaciones de la visita:");

    const nuevaVisita = {
      orden,
      entrega,
      armazon,
      ojode,
      ojoiz,
      add,
      material,
      observaciones,
      fecha: new Date().toISOString()
    };

    db.ref("clientes/" + id + "/visitas").once("value", snapshot => {
      const visitas = snapshot.val() || [];
      visitas.push(nuevaVisita);
      db.ref("clientes/" + id + "/visitas").set(visitas)
        .then(() => {
          alert("Visita agregada correctamente.");
          verDetalleCliente(id);
        })
        .catch(err => alert("Error al agregar visita: " + err));
    });
  }



function mostrarFormularioEdicionCompleta(id) {
  db.ref("clientes/" + id).once("value", snapshot => {
    const cliente = snapshot.val();
    if (!cliente) return alert("Cliente no encontrado.");

    document.getElementById('formularioCliente').style.display = 'block';
    document.getElementById('busquedaCliente').style.display = 'none';

    const form = document.getElementById('clienteForm');
    form.nombre.value = cliente.nombre || "";
    form.armazon.value = cliente.armazon || "";
    form.ojode.value = cliente.ojode || "";
    form.ojoiz.value = cliente.ojoiz || "";
    form.add.value = cliente.add || "";
    form.material.value = cliente.material || "";
    form.orden.value = cliente.orden || "";
    form.entrega.value = cliente.entrega || "";
    form.telefono.value = cliente.telefono || "";
    form.fechaNacimiento.value = cliente.fechaNacimiento || "";
    form.obse.value = cliente.obse || "";

    clienteSeleccionadoId = id;
  });
}

document.getElementById("clienteForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  const cliente = Object.fromEntries(formData.entries());

  if (clienteSeleccionadoId) {
    // Actualiza datos
    db.ref("clientes/" + clienteSeleccionadoId).update(cliente)
      .then(() => {
        alert("Cliente actualizado exitosamente.");
        this.reset();
        clienteSeleccionadoId = null;
        mostrarBusqueda();
      })
      .catch(err => alert("Error al actualizar: " + err));
  } else {
    // Agrega nuevo cliente
    cliente.visitas = [{ ...cliente, fecha: new Date().toISOString() }];
   const nuevoClienteRef = db.ref("clientes").push();
cliente.id = nuevoClienteRef.key;
nuevoClienteRef.set(cliente)


      .then(() => {
        alert("Cliente agregado exitosamente.");
        this.reset();
      })
      .catch(err => alert("Error al guardar: " + err));
  }
});

  function mostrarFormularioVisita(id) {
  clienteSeleccionadoId = id;
  document.getElementById("formulario-visita").style.display = "block";
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function guardarNuevaVisita() {
  if (!clienteSeleccionadoId) return alert("Cliente no seleccionado.");

  const visita = {
    orden: document.getElementById("orden").value,
    entrega: document.getElementById("entrega").value,
    armazon: document.getElementById("armazon").value,
    ojode: document.getElementById("ojode").value,
    ojoiz: document.getElementById("ojoiz").value,
    add: document.getElementById("add").value,
    material: document.getElementById("material").value,
    obse: document.getElementById("observaciones").value,
    fecha: new Date().toISOString()
  };

  const ref = db.ref("clientes/" + clienteSeleccionadoId + "/visitas");
  ref.once("value").then(snapshot => {
    const visitas = snapshot.val() || [];
    visitas.push(visita);
    return ref.set(visitas);
  }).then(() => {
    alert("Visita registrada correctamente.");
    document.getElementById("formulario-visita").style.display = "none";
    verDetalleCliente(clienteSeleccionadoId);
  }).catch(err => alert("Error al guardar visita: " + err));
}


function mostrarFormularioEdicion(id) {
  const resultados = document.getElementById("resultadosBusqueda");
  resultados.innerHTML = "";

  db.ref("clientes/" + id).once("value", snapshot => {
    const cliente = snapshot.val();
    if (!cliente) return;

    const div = document.createElement("div");
    div.className = "client-result";

    div.innerHTML = `
      <h4>Editar Cliente</h4>
      <label>Nombre:</label>
      <input type="text" id="nombre_${id}" value="${cliente.nombre || ""}">
      <label>Teléfono:</label>
      
      <input type="text" id="telefono_${id}" value="${cliente.telefono || ""}">
      <label>Fecha de Nacimiento:</label>
      <input type="date" id="fechaNacimiento_${id}" value="${cliente.fechaNacimiento || ""}">

      
      <label>Calle:</label>
<input type="text" id="calle_${id}" value="${cliente.calle || ""}">
<label>Colonia:</label>
<input type="text" id="colonia_${id}" value="${cliente.colonia || ""}">
<label>Código Postal:</label>
<input type="text" id="cp_${id}" value="${cliente.cp || ""}">

      <button onclick="actualizarCliente('${id}')">Guardar Cambios</button>
      <button onclick="verDetalleCliente('${id}')">Cancelar</button>
    `;

    resultados.appendChild(div);
  });
}
function eliminarVisita(idCliente, index) {
  if (confirm("¿Estás seguro de eliminar esta visita?")) {
    const clienteRef = db.ref("clientes/" + idCliente);

    clienteRef.once("value", snapshot => {
      const cliente = snapshot.val();
      if (!cliente || !cliente.visitas || !Array.isArray(cliente.visitas)) {
        alert("No se encontró la visita.");
        return;
      }

      // Eliminar la visita del array
      cliente.visitas.splice(index, 1);

      // Actualizar en Firebase
      clienteRef.update({ visitas: cliente.visitas })
        .then(() => {
          alert("Visita eliminada correctamente.");
          verDetalleCliente(idCliente); // Recargar detalles
        })
        .catch(error => {
          console.error("Error eliminando visita:", error);
          alert("Error al eliminar la visita.");
        });
    });
  }
}
function mostrarFormularioActualizarVisita(idCliente, index) {
  const ref = db.ref("clientes/" + idCliente);
  ref.once("value", snapshot => {
    const cliente = snapshot.val();
    if (!cliente || !cliente.visitas || !cliente.visitas[index]) return;

    const visita = cliente.visitas[index];
    const contenedor = document.getElementById(`formularioActualizarVisita-${index}`);

    contenedor.innerHTML = `
      <form onsubmit="guardarActualizacionVisita(event, '${idCliente}', ${index})" class="form-editar-visita">
        <label>Fecha de Orden: <input type="date" name="orden" value="${visita.orden || ""}" ></label><br>
        <label>Fecha de Entrega: <input type="date" name="entrega" value="${visita.entrega || ""}" ></label><br>
        <label>Material: <input type="text" name="material" value="${visita.material || ""}" ></label><br>
        <label>Graduación:</label><br>
        <label>O.D: <input type="text" name="ojode" value="${visita.ojode || ""}" ></label><br>
        <label>O.I: <input type="text" name="ojoiz" value="${visita.ojoiz || ""}" ></label><br>
        <label>ADD.: <input type="text" name="add" value="${visita.add || ""}" ></label><br>
        <label>Armazón: <input type="text" name="armazon" value="${visita.armazon || ""}" ></label><br>
        <label>Observaciones: <textarea name="obse">${visita.obse || ""}</textarea></label><br>
        <button type="submit">Guardar cambios</button>
        <button type="button" onclick="cancelarEdicionVisita(${index})">Cancelar</button>
      </form>
    `;
  });
}
function guardarActualizacionVisita(event, idCliente, index) {
  event.preventDefault();
  const form = event.target;

  const visitaActualizada = {
    orden: form.orden.value,
    entrega: form.entrega.value,
    material: form.material.value,
    ojode: form.ojode.value,
    ojoiz: form.ojoiz.value,
    add: form.add.value,
    armazon: form.armazon.value,
    obse: form.obse.value
  };

  const ref = db.ref("clientes/" + idCliente);
  ref.once("value", snapshot => {
    const cliente = snapshot.val();
    if (!cliente || !cliente.visitas || !cliente.visitas[index]) return;

    cliente.visitas[index] = visitaActualizada;

    ref.update({ visitas: cliente.visitas })
      .then(() => {
        alert("Visita actualizada correctamente.");
        verDetalleCliente(idCliente); // Recargar los detalles
      })
      .catch(error => {
        console.error("Error al actualizar visita:", error);
        alert("Error al guardar los cambios.");
      });
  });
}
    function cargarClientes() {
  const resultados = document.getElementById("resultadosBusqueda");

  let ref = db.ref("clientes").orderByKey().limitToFirst(pageSize + 1);

  if (lastKey && !firstLoad) {
    ref = db.ref("clientes").orderByKey().startAt(lastKey).limitToFirst(pageSize + 1);
  }

  ref.once("value", snapshot => {
    const data = snapshot.val();
    if (!data) {
      resultados.innerHTML = "<p>No hay clientes registrados.</p>";
      return;
    }

    const keys = Object.keys(data);
    if (!firstLoad) {
      keys.shift(); // evitar duplicado
    }

    lastKey = keys[keys.length - 1];

    keys.slice(0, pageSize).forEach(id => {
      const cliente = data[id];
      const div = document.createElement("div");
      div.className = "client-result";
      div.innerHTML = `
        <strong>${cliente.nombre}</strong><br>
        Tel: ${cliente.telefono || "-"}<br>
        <button onclick="verDetalleCliente('${id}')">Ver detalles</button>
      `;
      resultados.appendChild(div);
    });

    const botones = document.getElementById("botonesPaginacion") || document.createElement("div");
    botones.id = "botonesPaginacion";
    botones.innerHTML = "";

    if (keys.length > pageSize) {
      const btn = document.createElement("button");
      btn.textContent = "Siguiente página";
      btn.onclick = () => {
        firstLoad = false;
        cargarClientes();
      };
      botones.appendChild(btn);
    }

    resultados.appendChild(botones);
  });
}

function cancelarEdicionVisita(index) {
  const contenedor = document.getElementById(`formularioActualizarVisita-${index}`);
  contenedor.innerHTML = ""; // Limpia el formulario
}
function cancelarFormularioVisita() {
  const formulario = document.getElementById("formulario-visita");
  if (formulario) {
    formulario.style.display = "none";
  }
}



  </script>
</body>
</html>

